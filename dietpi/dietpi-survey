#!/bin/bash
{
	#////////////////////////////////////
	# DietPi Survey Script
	#
	#////////////////////////////////////
	# Created by Daniel Knight / daniel.knight@dietpi.com / dietpi.com
	#
	#////////////////////////////////////
	#
	# Info:
	# - http://dietpi.com/phpbb/viewtopic.php?f=8&t=20
	# - Sends DietPi statistics to SFTP server (eg: what programs are installed, hardware model)
	# - Allows the DietPi project to focus on areas based on popularity.
	# - No private data is sent. Noone can indentify you.
	# - Runs on dietpi-update and when user installs software using dietpi-software
	#
	# Usage:
	# - /DietPi/dietpi/dietpi-survey	Interactively let user opt-in, opt-out or remove uploaded data
	# - /DietPi/dietpi/dietpi-survey 1	Non-interactively send survey data, IF user opted in (!)
	#
	# File Sent format:
	# $(sed -n 5p /DietPi/dietpi/.hw_model).txt
	#////////////////////////////////////

	#Import DietPi-Globals ---------------------------------------------------------------
	. /DietPi/dietpi/func/dietpi-globals
	export G_PROGRAM_NAME='DietPi-Survey'
	export G_USER_INPUTS=0
	G_CHECK_ROOT_USER
	G_INIT
	#Import DietPi-Globals ---------------------------------------------------------------

	#Grab Input (valid interger)
	INPUT=0
	G_CHECK_VALIDINT $1 && INPUT=$1

	OPTED_IN=0
	SURVEY_SENTCOUNT=1
	SURVEY_VERSION=5

	DIETPI_VERSION="$(paste -sd '.' /DietPi/dietpi/.version)"
	G_HW_MODEL=$(sed -n 1p /DietPi/dietpi/.hw_model)
	UNIQUE_ID=$(sed -n 5p /DietPi/dietpi/.hw_model)

	SFTP_ADDR='dietpi.com'
	SFTP_USER='dietpi-survey'
	SFTP_PASS='upload2dietpi'

	FP_SETTINGS='/DietPi/dietpi/.dietpi-survey'
	Write_Settings(){

		cat << _EOF_ > $FP_SETTINGS
$OPTED_IN
$SURVEY_SENTCOUNT
_EOF_

	}

	Read_Settings(){

		OPTED_IN=$(sed -n 1p $FP_SETTINGS)
		SURVEY_SENTCOUNT=$(sed -n 2p $FP_SETTINGS)

	}

	Send_File(){

		#Check if we have a working internet connection beforehand
		G_CHECK_URL "$SFTP_ADDR"

		#upload to server
		curl -m 20 --retry 1 --retry-delay 4 -sT "$FILENAME_FORMAT" sftp://"$SFTP_USER":"$SFTP_PASS"@"$SFTP_ADDR"/survey/

		#Update .dietpi-survey file
		((SURVEY_SENTCOUNT++))

	}

	#/////////////////////////////////////////////////////////////////////////////////////
	# Main Loop
	#/////////////////////////////////////////////////////////////////////////////////////
	#Enter ramfs
	mkdir -p /tmp/dietpi-survey
	cd /tmp/dietpi-survey
	
	#Read data from .dietpi-survey file
	if [[ -f $FP_SETTINGS ]]; then

		Read_Settings

	#Create new file + generate UUID
	else

		Write_Settings

	fi

	#Grab filename to use
	FILENAME_FORMAT="$UNIQUE_ID.txt"

	#Generate text file for upload
	cat << _EOF_ > "$FILENAME_FORMAT"
-------------------------
DietPi-Survey v$SURVEY_VERSION
-------------------------

Upload Count   : $SURVEY_SENTCOUNT
DietPi Version : $DIETPI_VERSION
Hardware Index : $G_HW_MODEL
Hardware Name  : $G_HW_MODEL_DESCRIPTION
Distro Index   : $G_DISTRO
Autoboot Index : $(</DietPi/dietpi/.dietpi-autostart_index)
Hostname       : $(</etc/hostname)

-------------------------
DietPi-Software Installed
-------------------------
$(cat /DietPi/dietpi/.installed | grep '=2')

_EOF_

	#-----------------------------------------------------------------------------------
	if (( $INPUT == 1 )); then

		#Opted in - Setup and send
		if (( $OPTED_IN )); then

			Send_File

		fi

	else

		G_WHIP_MENU_ARRAY=(

			'1' 'Yes, I want to join DietPi-Survey.'
			'2' 'No, do not send data from my device.'
			'3' 'No, do not send data and remove my data, if already collected before.'

		)

		G_WHIP_MENU "DietPi-Survey would like to collect anonymous statistics about your device, version and installed software. \
This allows us to focus development based on popularity. NO private data is sent and NOONE can identify you based on the data sent. \
The data is sent via secured connection to our SFTP server and is stored there unreadable to the public upload user. \
If you agree, your uploaded data will be automatically updated on every DietPi-Update and whenever you install software via DietPi-Software \
We regularly publish results of the collected data at: https://dietpi.com/forum
Your personal upload file would currently look like this:
$(cat $FILENAME_FORMAT)

Would you like to opt in for DietPi-Survey?"
		if (( ! $? )); then

			if (( G_WHIP_RETURNED_VALUE == 1 )); then

				OPTED_IN=1
				Send_File

			elif (( G_WHIP_RETURNED_VALUE == 2 )); then

				OPTED_IN=0

			elif (( G_WHIP_RETURNED_VALUE == 3 )); then

				OPTED_IN=0
				# Send empty file to overwrite existing data, rm is not possible due to missing file list permissions
				> "$FILENAME_FORMAT"
				((SURVEY_SENTCOUNT--)) # Compensate upcount by Send_File
				Send_File
				
			fi

		fi

	fi

	Write_Settings
	cd "$HOME"
	rm -R /tmp/dietpi-survey

	#-----------------------------------------------------------------------------------
	exit 0
	#-----------------------------------------------------------------------------------

}
