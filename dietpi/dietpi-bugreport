#!/bin/bash
{
	#////////////////////////////////////
	# DietPi Bug Report Script
	#
	#////////////////////////////////////
	# Created by Daniel Knight / daniel.knight@dietpi.com / dietpi.com
	#
	#////////////////////////////////////
	#
	# Info:
	# - Called from G_ERROR_HANDLER
	# - filename /DietPi/dietpi/dietpi-bugreport
	# - Generates $UNIQUE_ID_HW.7z and uploads to dietpi.com
	# Usage:
	# - /DietPi/dietpi/dietpi-bugreport 1				#Automated send of bug report
	#////////////////////////////////////

	#Import DietPi-Globals ---------------------------------------------------------------
	. /DietPi/dietpi/func/dietpi-globals
	export G_PROGRAM_NAME='DietPi-Bugreport'
	G_CHECK_ROOT_USER
	G_CHECK_ROOTFS_RW
	G_INIT
	G_USER_INPUTS=0
	#Import DietPi-Globals ---------------------------------------------------------------

	INPUT=0
	G_CHECK_VALIDINT $1 && INPUT=$1

	UNIQUE_ID_HW=$(sed -n 5p /DietPi/dietpi/.hw_model)
	FP_TMP='/tmp/dietpi-bugreport'
	UPLOAD_FILENAME="$UNIQUE_ID_HW.7z"

	# - byte
	UPLOAD_FILESIZE_LIMIT=10000000
	UPLOAD_FILESIZE=0

	SFTP_ADDR='dietpi.com'
	SFTP_USER='dietpi-survey'
	SFTP_PASS='upload2dietpi'

	Generate_Upload_File(){

		#----------------------------------------------------------------
		#Define 7zip settings: 7z archive, preserve absolute file paths
		local 7z_settings='-t7z -spf'
		#----------------------------------------------------------------
		#List of commands we want to run and redirect to upload archive
		local acommand_list=(

			'ls -lha /var/log'
			'dpkg -l'
			'ifconfig -a'
			'ip a'
			'lsusb'
			'cat /proc/cpuinfo'
			'ps aux'
			'blkid'
			'mount'
			'df -h'
			"ls /etc/rc*.d/"
			'cut -d: -f1 /etc/passwd'
			'locale'
			'ls -lha /mnt' #dietpi userdata location
			'dmesg'
			'lsmod'
			"systemctl status *.service -l"
			"systemctl status *.mount -l"
			'/DietPi/dietpi/dietpi-services status'

		)

		for ((i=0; i<${#acommand_list[@]}; i++))
		do

			echo -e "\n----------\n${acommand_list[$i]}:\n----------" >> br_cmd_out.txt
			${acommand_list[$i]} >> br_cmd_out.txt

		done

		unset acommand_list

		#list of files and/or folders we want to zip
		afile_list=(

			# - command output file
			'br_cmd_out.txt'

			# - logs
			"/var/log/*"

			# - DietPi scripts / logs
			"/DietPi/*"
			'/boot/dietpi.txt'
			'/boot/config.txt'
			"/boot/dietpi/*"
			"/tmp/.G*"
			"/var/tmp/dietpi/logs/*"

			# - /var/lib/dietpi
			"/var/lib/dietpi/*"

			# - confs
			#	- bash shell
			'/etc/bash.bashrc'
			"/etc/bashrc.d/*"
			'/root/.bashrc'
			"/home/*/.bashrc"
			#	- login shell
			'/etc/profile'
			"/etc/profile.d/*"
			'/root/.profile'
			"/home/*/.profile"

			'/etc/rc.local'
			'/etc/X11/xorg.conf'
			'/etc/asound.conf'
			'/etc/network/interfaces'
			'/etc/fstab'
			'/etc/sysctl.conf'
			"/etc/sysctl.d/*"

			# - Services
			"/etc/init.d/*"
			"/etc/systemd/system/*"
			"/lib/systemd/system/*"

			# - APT
			'/etc/apt/sources.list'
			"/etc/apt/sources.list.d/*"

		)

		7z a "$7z_settings" "$UPLOAD_FILENAME" ${afile_list[@]}

	}

	Create_Bug_Report(){

		#----------------------------------------------------------------
		#Generate our 7z bug report file
		Generate_Upload_File

		#----------------------------------------------------------------
		#Check upload location is online
		G_CHECK_URL "$SFTP_ADDR"
		if (( ! $? )); then

			#Limit filesize
			UPLOAD_FILESIZE=$(stat -c%s "$UPLOAD_FILENAME")

			# - Upload
			if (( $UPLOAD_FILESIZE <= $UPLOAD_FILESIZE_LIMIT )); then

				G_DIETPI-NOTIFY 2 'Uploading bug report, please wait...'
				curl -m 20 --retry 1 --retry-delay 4 -sT "$UPLOAD_FILENAME" sftp://"$SFTP_USER":"$SFTP_PASS"@"$SFTP_ADDR"/bugreport/
				if (( ! $? )); then

					G_DIETPI-NOTIFY 0 "Bug report sent, reference code: $UNIQUE_ID_HW"

				else

					G_DIETPI-NOTIFY 1 'Failed to upload bug report to SFTP server. Please try again later or report this to DietPi forum or GitHub repo in the first place.'

				fi

			else

				G_DIETPI-NOTIFY 1 'The bug report upload archive appears to be unexpected large. Please inspect and in case clean up the locations to be uploaded, as their size should never be that large:'
				printf "%s\n" "${afile_list[@]}"

			fi

		else

			G_DIETPI-NOTIFY 1 'Failed to connect to "dietpi.com". Please try again later or report this to DietPi forum or GitHub repo in the first place.'

		fi

		unset afile_list

	}

	#/////////////////////////////////////////////////////////////////////////////////////
	# Main Loop
	#/////////////////////////////////////////////////////////////////////////////////////
	#----------------------------------------------------------------
	if (( $INPUT == 1 )); then

		#Make Directory
		#	we need to work inside the directory as Wput cant accept /paths
		rm -R "$FP_TMP"
		mkdir -p "$FP_TMP"
		cd "$FP_TMP"

		#Automated bug report send
		Create_Bug_Report

		#remove temp folder and all generated temp files
		cd "$HOME"
		rm -R "$FP_TMP"

	else

		G_DIETPI-NOTIFY 2 'This feature is no longer available. Now handled automatically by G_ERROR_HANDLER when an issue occurs'

	fi

	#-----------------------------------------------------------------------------------
	exit 0
	#-----------------------------------------------------------------------------------

}
