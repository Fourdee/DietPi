#!/bin/bash
{
	#////////////////////////////////////
	# DietPi PreBoot Script
	#
	#////////////////////////////////////
	# Created by Daniel Knight / daniel.knight@dietpi.com / dietpi.com
	#
	#////////////////////////////////////
	#
	# Info:
	# - filename /DietPi/dietpi/preboot
	# - activates on boot from dietpi-preboot.service, runs before dietpi-boot.service and networking
	#////////////////////////////////////

	# Import DietPi-Globals --------------------------------------------------------------
	/DietPi/dietpi/func/dietpi-obtain_hw_model # Runs every boot to allow e.g. switching SDcards between devices and to be failsafe
	. /DietPi/dietpi/func/dietpi-globals
	G_PROGRAM_NAME='DietPi-PreBoot'
	G_INIT
	# Import DietPi-Globals --------------------------------------------------------------

	#/////////////////////////////////////////////////////////////////////////////////////
	# Globals
	#/////////////////////////////////////////////////////////////////////////////////////

	RPi_Set_Clock_Speeds(){

		# If no manual overclock settings have been applied by user, set non/safe overclocking values as commented defaults
		if ! grep -qE '^[[:blank:]]*(over_voltage|(arm|core|gpu|sdram)_freq)=' /DietPi/config.txt; then

			# Zero
			if [[ ${G_HW_MODEL_DESCRIPTION,,} == *'zero'* ]]; then

				sed -i '/over_voltage=/c\#over_voltage=0' /DietPi/config.txt
				sed -i '/arm_freq=/c\#arm_freq=1000' /DietPi/config.txt
				sed -i '/core_freq=/c\#core_freq=400' /DietPi/config.txt
				sed -i '/sdram_freq=/c\#sdram_freq=450' /DietPi/config.txt

			# RPi v1 - Apply safe overclock mode
			elif (( $G_HW_MODEL < 2 )); then

				G_CONFIG_INJECT 'over_voltage=' 'over_voltage=2' /DietPi/config.txt
				G_CONFIG_INJECT 'arm_freq=' 'arm_freq=900' /DietPi/config.txt
				sed -i '/core_freq=/c\#core_freq=250' /DietPi/config.txt
				sed -i '/sdram_freq=/c\#sdram_freq=400' /DietPi/config.txt

			# RPi v2
			elif (( $G_HW_MODEL == 2 )); then

				sed -i '/over_voltage=/c\#over_voltage=0' /DietPi/config.txt
				sed -i '/arm_freq=/c\#arm_freq=900' /DietPi/config.txt
				sed -i '/core_freq=/c\#core_freq=250' /DietPi/config.txt
				sed -i '/sdram_freq=/c\#sdram_freq=450' /DietPi/config.txt

			# RPi v3 B+
			elif [[ ${G_HW_MODEL_DESCRIPTION,,} == *'rpi 3 model b+'* ]]; then

				sed -i '/over_voltage=/c\#over_voltage=0' /DietPi/config.txt
				sed -i '/core_freq=/c\#core_freq=400' /DietPi/config.txt
				G_CONFIG_INJECT '/temp_limit=' 'temp_limit=75' /DietPi/config.txt # https://github.com/MichaIng/DietPi/issues/356
				sed -i '/arm_freq=/c\#arm_freq=1400' /DietPi/config.txt
				sed -i '/sdram_freq=/c\#sdram_freq=500' /DietPi/config.txt

			# RPi v3
			elif (( $G_HW_MODEL == 3 )); then

				sed -i '/over_voltage=/c\#over_voltage=0' /DietPi/config.txt
				sed -i '/core_freq=/c\#core_freq=400' /DietPi/config.txt
				G_CONFIG_INJECT '/temp_limit=' 'temp_limit=75' /DietPi/config.txt # https://github.com/MichaIng/DietPi/issues/356
				sed -i '/arm_freq=/c\#arm_freq=1200' /DietPi/config.txt
				sed -i '/sdram_freq=/c\#sdram_freq=450' /DietPi/config.txt

			fi

		fi

	}



	#/////////////////////////////////////////////////////////////////////////////////////
	# Main Loop
	#/////////////////////////////////////////////////////////////////////////////////////
	#-----------------------------------------------------------------------------------
	# Apply DietPi CPU Governor and settings
	G_THREAD_START /DietPi/dietpi/func/dietpi-set_cpu

	# Apply LED triggers if set
	G_THREAD_START /DietPi/dietpi/func/dietpi-led_control 1

	#-----------------------------------------------------------------------------------
	# First run prep
	if (( $G_DIETPI_INSTALL_STAGE == -1 )); then

		#----------------------------------------------------------------
		# Workarounds
		# - Workaround for NanoPi Fire3 with tty1 disabled: https://github.com/MichaIng/DietPi/issues/2225
		if (( $G_HW_MODEL == 62 )) && dmesg | grep -qi 'NanoPi Fire3'; then

			chvt 2
			echo -e '#!/bin/dash\nchvt 2' > /var/lib/dietpi/postboot.d/fire3_tty2

		fi
		#----------------------------------------------------------------

		# - Set RPi v1 safe overclocking profile (900MHz) and apply commented defaults based on RPi model
		(( $G_HW_MODEL < 10 )) && RPi_Set_Clock_Speeds

		# - End user automated script
		if [[ -f /boot/Automation_Custom_PreScript.sh ]]; then

			G_DIETPI-NOTIFY 2 'Running custom script, please wait...'

			local fp_log='/var/tmp/dietpi/logs/dietpi-automation_custom_prescript.log'
			chmod +x /boot/Automation_Custom_PreScript.sh
			if /boot/Automation_Custom_PreScript.sh | tee $fp_log; then

				G_DIETPI-NOTIFY 0 'Custom script'

			else

				G_DIETPI-NOTIFY 1 "Custom script: Please see the log file for more information $fp_log"

			fi

		fi

	fi
	#-----------------------------------------------------------------------------------
	G_THREAD_WAIT
	exit
	#-----------------------------------------------------------------------------------
}
