#!/bin/bash
{
	#////////////////////////////////////
	# DietPi-Globals
	#
	#////////////////////////////////////
	# Created by Daniel Knight / daniel.knight@dietpi.com / dietpi.com
	#
	#////////////////////////////////////
	#
	# Info:
	# - Allows export of shared DietPi global variables into current bash session, and, other scripts
	# Notes:
	# - . /DietPi/dietpi/func/dietpi-globals > $HOME/.bashrc
	# - . /DietPi/dietpi/func/dietpi-globals > for each script that uses these globals
	#////////////////////////////////////

	#Non-configured DietPi system, simply exit.
	if [ ! -f /DietPi/dietpi/func/dietpi-globals ]; then

		exit 0

	fi

	#/DietPi/dietpi/func/dietpi-notify 2 'Updating DietPi-Globals, please wait...'

	#-----------------------------------------------------------------------------------
	# Core var's, functions, environment checks. Used at start of all scripts.
	#-----------------------------------------------------------------------------------
	#Prevent incorrect parsing with non-english locales.
	LANG=en_GB.UTF-8

	#Ensure we are in users home dir: https://github.com/Fourdee/DietPi/issues/905#issuecomment-298223705
	cd "$HOME"

	CHECK_ROOT_USER(){

		if (( $UID != 0 )); then

			/DietPi/dietpi/func/dietpi-notify 1 'Error: Root privileges required. Please run the command with "sudo"\n'
			exit 1

		fi

	}

	CHECK_ROOTFS_RW(){

		#RootFS RW check
		/DietPi/dietpi/dietpi-drive_manager 3
		if (( $? != 0 )); then

			/DietPi/dietpi/func/dietpi-notify 1 'Error: RootFS is currently Read Only, unable to continue.\n'
			exit 1

		fi

	}

	#-----------------------------------------------------------------------------------
	# DietPi First-Run Stage
	#-----------------------------------------------------------------------------------
	# -1 = first boot / 0 = run dietpi-software at login / 1 = completed
	DIETPI_INSTALL_STAGE=$(cat /DietPi/dietpi/.install_stage)

	#-----------------------------------------------------------------------------------
	# Hardware Details
	#-----------------------------------------------------------------------------------
	#Update?
	if [ ! -f /DietPi/dietpi/.hw_model ]; then

		/DietPi/dietpi/dietpi-obtain_hw_model

	fi

	HW_MODEL=$(sed -n 1p /DietPi/dietpi/.hw_model)
	HW_MODEL_DESCRIPTION=$(sed -n 2p /DietPi/dietpi/.hw_model)
	HW_ARCH=$(sed -n 6p /DietPi/dietpi/.hw_model)
	HW_CPU_CORES=$(nproc --all)
	HW_CPUID=$(sed -n 9p /DietPi/dietpi/.hw_model)

	DISTRO=$(sed -n 3p /DietPi/dietpi/.hw_model)
	DISTRO_NAME='jessie'
	if (( $DISTRO == 4 )); then

		DISTRO_NAME='stretch'

	elif (( $DISTRO == 5 )); then

		DISTRO_NAME='buster'

	fi
	#-----------------------------------------------------------------------------------
	# DietPi specific directories
	#-----------------------------------------------------------------------------------
	FP_DIETPI_USERDATA='/mnt/dietpi_userdata'
	#FP_DIETPI_VAR_LIB='/var/lib/dietpi'
	#FP_DIETPI_VAR_TMP='/var/tmp/dietpi'

	#-----------------------------------------------------------------------------------
	# APT
	#-----------------------------------------------------------------------------------
	FP_LOG_APT='/var/tmp/dietpi/logs/dietpi-software_apt.log'
	EXITCODE_APT=0 #only way I found of exporting the exit code, once the command is run.

	#Support for apt-fast: https://github.com/Fourdee/DietPi/issues/698
	# APT_BINARY='apt-get'
	# if [ -f /usr/bin/apt-fast ]; then

		# APT_BINARY='apt-fast'

	# fi

	AGI(){

		local string="$@"
		local force_options=''

		if (( $DISTRO >= 4 )); then

			force_options='--allow-downgrades --allow-remove-essential --allow-change-held-packages --allow-unauthenticated'

		else

			force_options='--force-yes'

		fi

		#-qq can add a slight period of appearing nothing is happening, lets inform user
		/DietPi/dietpi/func/dietpi-notify 2 "APT installation for: $string"
		/DietPi/dietpi/func/dietpi-notify 2 "APT is processing, please wait...\n"
		DEBIAN_FRONTEND=noninteractive apt-get install -y -qq $force_options $string 2>&1 | tee "$FP_LOG_APT"
		EXITCODE_APT=${PIPESTATUS[0]}

	}

	#apt-get purge
	AGP(){

		local string="$@"
		local options=''
		if (( $DISTRO >= 4 )); then

			options+=' --allow-change-held-packages'

		fi

		/DietPi/dietpi/func/dietpi-notify 2 "APT removal for: $string"
		apt-get purge -y $string $options
		EXITCODE_APT=${PIPESTATUS[0]}

	}

	#apt-get autoremove
	AGA(){

		/DietPi/dietpi/func/dietpi-notify 2 "APT autoremove + purge"
		apt-get autoremove --purge -y
		EXITCODE_APT=${PIPESTATUS[0]}

	}

	#apt-get install -f
	AGF(){

		/DietPi/dietpi/func/dietpi-notify 2 "APT fix"
		DEBIAN_FRONTEND=noninteractive apt-get install -f -y $force_options 2>&1 | tee "$FP_LOG_APT"
		EXITCODE_APT=${PIPESTATUS[0]}

	}

	#-----------------------------------------------------------------------------------
	#/DietPi/dietpi/func/dietpi-notify 0 'DietPi-Globals\n'
	#-----------------------------------------------------------------------------------
}
